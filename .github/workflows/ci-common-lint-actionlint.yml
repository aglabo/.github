# src: ./.github/workflows/ci-common-lint-actionlint.yml
# @(#) : GitHub Actions workflow for actionlint validation
#
# Copyright (c) 2025 atsushifx <https://github.com/atsushifx>
#
# This software is released under the MIT License.
# https://opensource.org/licenses/MIT

name: Common CI Actionlint

# Minimal permissions following security best practices
permissions:
  contents: read

# Reusable workflow trigger
on:
  workflow_call:
    inputs:
      config-file:
        type: string
        default: ".shared/configs/actionlint.yaml"
        description: "Path to actionlint config file"
        required: false
      actionlint-version:
        type: string
        default: "1.7.10"
        description: "actionlint version to install"
        required: false

jobs:
  actionlint:
    name: Lint GitHub Actions workflows
    runs-on: ubuntu-slim
    timeout-minutes: 10

    steps:
      # Step 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      # Step 2: Checkout shared configs from aglabo/.github
      - name: Checkout shared configs
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          repository: aglabo/.github
          ref: releases
          path: .shared
          persist-credentials: false

      # Step 3: Setup actionlint binary
      - name: Setup actionlint
        uses: aglabo/.github/.github/actions/setup-actionlint@r1.1.2
        with:
          version: ${{ inputs.actionlint-version }}

      # Step 4: Run actionlint with JSON output
      - name: Run actionlint
        id: actionlint-run
        run: |
          mkdir -p .github/report

          set +e
          actionlint -config-file ${{ inputs.config-file }} -color 2>&1 | tee .github/report/report.log
          actionlint_status=${PIPESTATUS[0]}
          set -e

          echo "status=${actionlint_status}" >> "$GITHUB_OUTPUT"
          exit "${actionlint_status}"

      # Step 5: Upload error report as artifact (only on failure)
      - name: Upload actionlint report
        if: failure() && steps.actionlint-run.outputs.status != '0'
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: actionlint-report
          path: .github/report/report.json
          retention-days: 30
