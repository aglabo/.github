# src: ./.github/workflows/ci-common-lint-ghalint.yml
# @(#) : GitHub Actions workflow for ghalint validation
#
# Copyright (c) 2025 atsushifx <https://github.com/atsushifx>
#
# This software is released under the MIT License.
# https://opensource.org/licenses/MIT

name: Common CI Ghalint

# Minimal permissions following security best practices
permissions:
  contents: read

# Reusable workflow trigger
on:
  workflow_call:
    inputs:
      config-file:
        type: string
        default: ".shared/configs/ghalint.yaml"
        description: "Path to ghalint config file"
        required: false
      ghalint-version:
        type: string
        default: "1.5.5"
        description: "ghalint version to install"
        required: false

jobs:
  ghalint:
    name: Lint GitHub Actions workflows
    runs-on: ubuntu-slim
    timeout-minutes: 10

    steps:
      # Step 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      # Step 2: Checkout shared configs from aglabo/.github
      - name: Checkout shared configs
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          repository: aglabo/.github
          ref: releases
          path: .shared
          persist-credentials: false

      # Step 3: Setup ghalint binary
      - name: Setup ghalint
        uses: aglabo/.github/.github/actions/setup-ghalint@r1.2.1
        with:
          version: ${{ inputs.ghalint-version }}

      # Step 4: Run ghalint with color output
      - name: Run ghalint
        id: ghalint-run
        run: |
          mkdir -p .github/report

          set +e
          ghalint run --log-color always -c ${{ inputs.config-file }} 2>&1 | tee .github/report/report.log
          ghalint_status=${PIPESTATUS[0]}
          set -e

          {
            echo "status=${ghalint_status}"
          } >> "$GITHUB_OUTPUT"
          exit "${ghalint_status}"

      # Step 5: Upload error report as artifact (only on failure)
      - name: Upload ghalint report
        if: failure() && steps.ghalint-run.outputs.status != '0'
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: ghalint-report
          path: .github/report/report.log
          retention-days: 30
