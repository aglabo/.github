# src: ./.github/workflows/ci-common-scan-gitleaks.yml
# @(#) : GitHub Actions workflow for Gitleaks secret scanning
#
# Copyright (c) 2025 atsushifx <https://github.com/atsushifx>
#
# This software is released under the MIT License.
# https://opensource.org/licenses/MIT

name: Common CI Scan Gitleaks

# Minimal permissions following security best practices
permissions:
  contents: read

# Reusable workflow trigger
on:
  workflow_call:
    inputs:
      config-file:
        type: string
        default: ".shared/configs/gitleaks.toml"
        description: "Path to gitleaks config file"
        required: false
      gitleaks-version:
        type: string
        default: "8.30.0"
        description: "gitleaks version to install"
        required: false
      fetch-depth:
        type: number
        default: 1
        description: "Git history depth to fetch (0 for full history)"
        required: false

jobs:
  gitleaks:
    name: Scan secrets with Gitleaks
    runs-on: ubuntu-slim
    timeout-minutes: 10

    steps:
      # Step 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: ${{ inputs.fetch-depth }}
          persist-credentials: false

      # Step 2: Checkout shared configs from aglabo/.github
      - name: Checkout shared configs
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          repository: aglabo/.github
          ref: releases
          path: .shared
          persist-credentials: false

      # Step 3: Setup Gitleaks binary
      - name: Setup Gitleaks
        uses: aglabo/.github/.github/actions/setup-gitleaks@r1.1.1
        with:
          version: ${{ inputs.gitleaks-version }}

      # Step 4: Prepare report directory
      - name: Prepare report directory
        run: mkdir -p .github/report

      # Step 5: Run Gitleaks
      - name: Run Gitleaks
        id: gitleaks-run
        run: |
          set +e
          gitleaks protect \
            --source=. \
            --config=${{ inputs.config-file }} \
            --report-path=.github/report/gitleaks-report.json \
            --exit-code=1 \
            --verbose
          gitleaks_status=$?
          set -e

          echo "status=${gitleaks_status}" >> "$GITHUB_OUTPUT"
          exit "${gitleaks_status}"

      # Step 6: Upload scan results (only on failure)
      - name: Upload Gitleaks report
        if: failure() && steps.gitleaks-run.outputs.status != '0'
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: gitleaks-report
          path: .github/report/gitleaks-report.json
          retention-days: 30
